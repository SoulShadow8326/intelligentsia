<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | Intelligentsia</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/chat.css">
</head>

<body data-page="chat">
    {goodheader}
    <main class="chat-wrap">
        <nav class="server-sidebar" aria-label="Servers">
            <div class="server-icon"></div>
            <div class="server-icon"></div>
            <div class="server-icon"></div>
        </nav>

        

        <section class="panel chat-panel">
            <div class="chat-main">
                <header class="chat-header">###########################################################################</header>
                <div class="messages" id="messages" aria-live="polite"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Message #revolt">
                    <button id="sendBtn">Send</button>
                </div>
            </div>
        </section>

        <aside class="right-sidebar">
            <div class="ann-header">Announcements</div>
            <div class="ann-list" id="annList">
                <div class="ann-item">Welcome to Intelligentsia.</div>
                <div class="ann-item">Stay alert. Stay informed.</div>
            </div>
        </aside>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded',function(){
      var input=document.getElementById('chatInput');
      var send=document.getElementById('sendBtn');
      var messages=document.getElementById('messages');
            function addMessage(text,me){
                if(!text) return;
                var row=document.createElement('div');
                row.className='msg-row';
                if(me){
                    row.classList.add('me-row');
                } else {
                    row.classList.add('you-row');
                }

                var avatar=document.createElement('div');
                avatar.className='msg-avatar';


                        var bubbleWrap=document.createElement('div');
                        bubbleWrap.className='msg-bubble';

                        var bubble=document.createElement('div');
                        bubble.className='msg'+(me? ' me':' you');
                        bubble.textContent=text;

                        var time=document.createElement('span');
                        time.className='msg-time';
                        var d=new Date();
                        time.textContent = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');

                        bubbleWrap.appendChild(bubble);

                        if(me){
                                            row.appendChild(avatar);
                                            row.appendChild(bubbleWrap);
                                            row.appendChild(time);
                                        } else {
                                            row.appendChild(time);
                                            row.appendChild(bubbleWrap);
                                            row.appendChild(avatar);
                                        }

                messages.appendChild(row);
                messages.scrollTop=messages.scrollHeight;
            }

            function sendMessage(){
                var text = input.value.trim();
                if(!text) return;
                addMessage(text, true);
                input.value = '';
                input.focus();
                fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                }).then(function(res){ return res.json(); }).then(function(data){
                    if(data && data.ok && data.reply){
                        addMessage(data.reply, false);
                    } else if(data && data.reply){
                        addMessage(data.reply, false);
                    } else {
                        addMessage('No reply received.', false);
                    }
                }).catch(function(){ addMessage('Error contacting server.', false); });
            }

            send.addEventListener('click', sendMessage);
            input.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });
    });
    </script>
</body>

</html>